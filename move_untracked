#!/usr/bin/bash

DEFAULT_DEST_DIR="./UNTRACKED"

SANITIZED_PWD="$(pwd)"
SANITIZED_PWD="${SANITIZED_PWD//[[:space:]]//}" # Remove all spaces
SANITIZED_PWD=`echo $SANITIZED_PWD | sed 's/\//__/g'`
SANITIZED_PWD=`echo $SANITIZED_PWD | sed 's/[.]//g'`

DEFAULT_TAR="$DEFAULT_DEST_DIR/$SANITIZED_PWD$(date +%Y%m%d_%H%M%S).tar"

# Check if a destination directory was provided as an argument
if [ -n "$1" ]; then
    DEST_DIR="$1"
else
    DEST_DIR="$DEFAULT_DEST_DIR"
fi

if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "ðŸš¨ Error: This directory is not a Git repository."
    exit 1
fi

if [ ! -d "$DEST_DIR" ]; then
    echo "Creating destination directory: $DEST_DIR"
    mkdir -p "$DEST_DIR"
fi

# 'git ls-files --others --exclude-standard' lists files that are:
#   --others: Not in the index (untracked).
#   --exclude-standard: Not ignored by .gitignore.
#   -z: Outputs a null-terminated list, which handles filenames with spaces/special characters.
# The list is stored in a temporary file to handle the null-termination safely.
UNTRACKED_FILES_TEMP=$(mktemp)
rm -rf fed fedd zed zedd qed qedd
#git ls-files --others --exclude-standard -z > "$UNTRACKED_FILES_TEMP"
git ls-files --others --exclude-standard    | \
    egrep -v tar$                           | \
    egrep -v ^[.]                           > "$UNTRACKED_FILES_TEMP"


# Check if there are any untracked files
if [ ! -s "$UNTRACKED_FILES_TEMP" ]; then
    echo "âœ… No untracked files found (excluding those in .gitignore)."
    rm "$UNTRACKED_FILES_TEMP"
    exit 0
fi

# Use a while loop to read the file line by line
GOGO=$(mktemp)
chmod +x $GOGO
while IFS= read -r LINE; do
    CWD_TO_ROOT=$(git rev-parse --show-cdup 2>/dev/null)
    # Construct the full path from where the script is run
    FULL_PATH="$CWD_TO_ROOT$LINE"
    # Print the file being moved
    printf "mv %-50s %-40s\n" "$FULL_PATH" "$DEST_DIR" >> "$GOGO"
done < "$UNTRACKED_FILES_TEMP"
cat $GOGO
$GOGO
rm "$UNTRACKED_FILES_TEMP"
rm "$GOGO"
