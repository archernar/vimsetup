#!/usr/bin/bash

# Default variable
SET_LIST=false
SET_LIST_ALL=false
SET_ALBUM=false
DRY_RUN=false
TARGET_DIR=""
ARTIST_NAME=""
BASE=`basename "$PWD"`

# Function to print usage
usage() {
    echo "Usage: $0 [-n|--dry-run] <directory> <artist_name>"
    echo "Example: $0 --dry-run ./Music 'The Beatles'"
    exit 1
}

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -n|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -l)
            SET_LIST=true
            shift
            ;;
        -all)
            SET_LIST_ALL=true
            shift
            OPTARG="$1"
            shift
            ;;
        -a)
            SET_ALBUM=true
            shift
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            ;;
        *)
            # Assign positional arguments
            if [ -z "$TARGET_DIR" ]; then
                TARGET_DIR="$1"
                ARTIST_NAME="$1"
            # elif [ -z "$ARTIST_NAME" ]; then
            #    ARTIST_NAME="$1"
            else
                echo "Error: Too many arguments provided."
                usage
            fi
            shift
            ;;
    esac
done

if [ "$SET_LIST_ALL" = true ]; then
for TARGET_DIR in $OPTARG*/; do
            if [ ! -d "$TARGET_DIR" ]; then
                echo "Error: Directory '$TARGET_DIR' not found."
                exit 1
            fi
            find "$TARGET_DIR" -type f -name "*.mp3" -print0 | while IFS= read -r -d '' file; do
                # Get the directory the file is in (The Album Folder)
                album_dir_path=$(dirname "$file")      
                album_dir_name=$(basename "$album_dir_path")

                # Get the parent of that directory (The Artist Folder)
                artist_dir_path=$(dirname "$album_dir_path")
                artist_dir_name=$(basename "$artist_dir_path")


                artist=$(ffprobe -v quiet -show_entries format_tags=artist -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
                album=$(ffprobe -v quiet -show_entries format_tags=album -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
                title=$(ffprobe -v quiet -show_entries format_tags=title -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
                
                # Check Artist (Quote variables to handle spaces safely)
                if [ "$tag_artist" != "$artist_dir_name" ]; then
                    mismatch_found=true
                    #echo -e "Artist Mismatch: Dir='$artist_dir_name' vs Tag='$tag_artist'"
                fi

                # Check Album
                if [ "$tag_album" != "$album_dir_name" ]; then
                    mismatch_found=true
                    #echo -e "Album Mismatch: Dir='$album_dir_name' vs Tag='$tag_album'"
                fi


                if [ -z "$artist" ]; then
                    echo -e "[Unknown]\t${file}"
                else
                    TAB="\t"
                    #echo -e "${artist}\t\t${album}\t\t${file}"
                    #echo -e "${artist}\t${artist_dir_name}\t${album}\t${album_dir_name}\t${file}"
                    echo -e "${artist}\t${artist_dir_name}\t${album}\t${album_dir_name}\t${title}"
                    #echo -e "${artist}$TAB${artist_dir_name}$TAB${album}$TAB${album_dir_name}$TAB${title}" | column -t -s $'\t'
                fi
            done
done
            exit 0
fi

if [ "$SET_LIST" = true ]; then
            if [ ! -d "$TARGET_DIR" ]; then
                echo "Error: Directory '$TARGET_DIR' not found."
                exit 1
            fi
            find "$TARGET_DIR" -type f -name "*.mp3" -print0 | while IFS= read -r -d '' file; do
                # Get the directory the file is in (The Album Folder)
                album_dir_path=$(dirname "$file")      
                album_dir_name=$(basename "$album_dir_path")

                # Get the parent of that directory (The Artist Folder)
                artist_dir_path=$(dirname "$album_dir_path")
                artist_dir_name=$(basename "$artist_dir_path")


                artist=$(ffprobe -v quiet -show_entries format_tags=artist -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
                album=$(ffprobe -v quiet -show_entries format_tags=album -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
                title=$(ffprobe -v quiet -show_entries format_tags=title -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
                
                # Check Artist (Quote variables to handle spaces safely)
                if [ "$tag_artist" != "$artist_dir_name" ]; then
                    mismatch_found=true
                    #echo -e "Artist Mismatch: Dir='$artist_dir_name' vs Tag='$tag_artist'"
                fi

                # Check Album
                if [ "$tag_album" != "$album_dir_name" ]; then
                    mismatch_found=true
                    #echo -e "Album Mismatch: Dir='$album_dir_name' vs Tag='$tag_album'"
                fi


                if [ -z "$artist" ]; then
                    echo -e "[Unknown]\t${file}"
                else
                    #echo -e "${artist}\t\t${album}\t\t${file}"
                    #echo -e "${artist}\t${artist_dir_name}\t${album}\t${album_dir_name}\t${file}"
                    echo -e "${artist}\t${artist_dir_name}\t${album}\t${album_dir_name}\t${title}"
                fi
            done
            exit 0
fi



# echo "$TARGET_DIR"
# echo "$ARTIST_NAME"

# Validate that we have the required arguments
if [ -z "$TARGET_DIR" ] || [ -z "$ARTIST_NAME" ]; then
    echo "Error: Missing directory or artist name."
    usage
fi

# Check if directory exists
if [ ! -d "$TARGET_DIR" ]; then
    echo "Error: Directory '$TARGET_DIR' does not exist."
    exit 1
fi

# Check for id3v2 unless it is a dry run (optional, but good practice to check anyway)
if ! command -v id3v2 &> /dev/null; then
    echo "Error: 'id3v2' is not installed."
    exit 1
fi

if [ "$DRY_RUN" = true ]; then
    echo "--- DRY RUN MODE: No files will be modified ---"
    echo "Target Directory: $TARGET_DIR"
    echo "New Artist Tag:   $ARTIST_NAME"
    echo "-----------------------------------------------"
fi

# Find files and process
found_files=0

while IFS= read -r -d '' file; do
    found_files=$((found_files+1))
    dir_path=$(dirname "$file")
    ALBUM_NAME=$(basename "$dir_path")

    if [ "$DRY_RUN" = true ]; then
        echo "[DRY RUN] Would set artist to '$ARTIST_NAME' for: $file"
        if [ "$SET_ALBUM" = true ]; then
            echo "[DRY RUN] Would set artist to '$ALBUM_NAME' for: $file"
        fi
    else
        echo "Processing: $file"
        id3v2 -a "$ARTIST_NAME" "$file"
        #echo $file
        if [ "$SET_ALBUM" = true ]; then
            id3v2 -A "$ALBUM_NAME" "$file"
        fi
    fi
done < <(find "$TARGET_DIR" -type f -name "*.mp3" -print0)

if [ "$found_files" -eq 0 ]; then
    echo "No .mp3 files found in $TARGET_DIR"
else
    echo "Done! Processed $found_files files."
fi
